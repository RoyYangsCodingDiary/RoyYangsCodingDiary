### Sample Output

#
## 9/6/2023
#
#SPX: 4490.35
#DJI: 34611.68
#NASDAQ: 13988.8
#Russell 2000: 1880.74
#S&P/TSX: 20375.14
#FTSE 100: 7437.93
#Euro Stoxx 50 Eur: 4239.35
#Shanghai Composite Index: 3152.2
#Hang Seng Index: 18437.48
#Nikkei 225: 33118.55
#VIX: 14.27
#STOXX 50 Volatility Eur: 16.80
#US Dollar Index: 104.88
#USD/CAD: 1.3635
#EUR/USD: 1.0726
#USD/CNY: 7.3155
#USD/JPY: 147.606
#GBP/USD: 1.2505
#SOFR: 5.31%
# 
#Headline CPI at 304.348 as of Jul 2023
#Core CPI at 308.801 as of Jul 2023
#Fed Funds at 5.33 as of Aug 2023
#Unemp. Rate at 3.8 as of Aug 2023
# 
#US 1 Month Yield: 5.37%
#US 3 Month Yield: 5.47%
#US 6 Month Yield: 5.54%
#US 1 Year Yield: 5.43%
#US 2 Year Yield: 5.01%
#US 3 Year Yield: 4.73%
#US 5 Year Yield: 4.42%
#US 7 Year Yield: 4.38%
#US 10 Year Yield: 4.29%
#US 30 Year Yield: 4.36%
# 
#Gold Spot:	$1,917.85, 0.06% from last close $1,916.61
#Palladium:	$1,216.00, 0.29% from last close $1,212.50
#Platinum Spot:	$915.50, 0.22% from last close $913.50
#Silver Spot:	$23.12, -0.39% from last close $23.21
#Natural Gas (Henry Hub):	$2.51, -0.4% from last close $2.51
#Heating Oil:	$84.80, 0.63% from last close $84.27
#Oil (Brent):	$90.88, 0.28% from last close $90.60
#Oil (WTI):	$87.72, 0.16% from last close $87.54
#Aluminium:	$2,193.44, -0.03% from last close $2,193.44
#Lead Spot:	$2,299.20, 1.14% from last close $2,299.20
#Nickel Spot:	$20,525.00, -1.32% from last close $20,525.00
#Zinc Spot:	$2,435.50, -0.81% from last close $2,435.50
#Cotton Spot:	$0.86, -2.7% from last close $0.86
#Oats Spot:	$4.91, 0.2% from last close $4.75
#Coffee Spot:	$1.53, 0.93% from last close $1.52
#Cocoa Spot:	$2,966.00, 0.92% from last close $2,964.00
#Lean Hog Spot:	$0.82, -1.35% from last close $0.82
#Corn Spot:	$4.71, -0.16% from last close $4.72
#Feeder Cattle:	$2.53, 0.81% from last close $2.53
#Milk Spot:	$18.53, 0.0% from last close $18.51
#Orange Juice:	$3.50, 5.74% from last close $3.46
#Soybeans Spot:	$13.60, 0.39% from last close $13.60
#Wheat Spot:	$215.75, -0.69% from last close $215.50
#Sugar Spot:	$0.26, -1.47% from last close $0.26
# 
#### Holidays
#No market holidays today
#
#### Speeches
#German Buba Wuermeling Speaks at 06:05
#ECB McCaul Speaks at 08:00
#Fed Collins Speaks at 08:30
#German Buba Wuermeling Speaks at 09:35
#BoC Rate Statement at 10:00
#German Buba Balz Speaks at 12:00
#Fed Logan Speaks at 15:00
#BoJ Board Member Nakagawa Speaks at 21:30
#
#### Economic Releases Today
# 02:00 EUR: German Factory Orders (MoM) (Jul) at -11.7%, down from previous 7.6%, below consensus of -4.0%
#03:30 EUR: HCOB Italy Construction PMI (MoM) (Aug) at 47.7, down from previous 48.0
#03:30 EUR: HCOB Germany Construction PMI (Aug) at 41.5, up from previous 41.0
#03:30 EUR: HCOB France Construction PMI (MoM) (Aug) at 42.4, down from previous 42.9
#03:30 EUR: HCOB Eurozone Construction PMI (MoM) (Aug) at 43.4, down from previous 43.5
#05:00 EUR: Retail Sales (YoY) (Jul) at -1.0%, same from previous -1.0%, above consensus of -1.2%
#05:00 EUR: Retail Sales (MoM) (Jul) at -0.2%, down from previous 0.2%, below consensus of -0.1%
#05:30 EUR: German 10-Year Bund Auction at 2.630%, up from previous 2.460%
#07:00 USD: MBA 30-Year Mortgage Rate at 7.21%, down from previous 7.31%
#07:00 USD: MBA Mortgage Applications (WoW) at -2.9%, down from previous 2.3%
#07:00 USD: MBA Purchase Index at 141.9, down from previous 144.9
#07:00 USD: Mortgage Market Index at 183.6, down from previous 189.0
#07:00 USD: Mortgage Refinance Index at 388.1, down from previous 407.1
#07:00 CAD: Leading Index (MoM) (Aug) at 0.05%, up from previous 0.04%
#08:15 CAD: Reserve Assets Total (Aug) at 114.7B, up from previous 114.5B
#08:30 USD: Exports at 251.66B, up from previous 247.50B
#08:30 USD: Imports at 316.70B, up from previous 313.00B
#08:30 USD: Trade Balance (Jul) at -65.00B, down from previous -63.70B, above consensus of -68.00B
#08:30 CAD: Exports (Jul) at 60.42B, up from previous 59.97B
#08:30 CAD: Imports (Jul) at 61.40B, down from previous 64.89B
#08:30 CAD: Labor Productivity (QoQ) (Q2) at -0.6%, up from previous -0.8%, below consensus of -0.1%
#08:30 CAD: Trade Balance (Jul) at -0.99B, up from previous -4.92B, above consensus of -3.65B
#08:55 USD: Redbook (YoY) at 4.1%, down from previous 4.2%
#09:45 USD: S&P Global Composite PMI (Aug) at 50.2, down from previous 52.0, below consensus of 50.4
#09:45 USD: S&P Global Services PMI (Aug) at 50.5, down from previous 52.3, below consensus of 51.0
#10:00 USD: IBD/TIPP Economic Optimism at 43.2, up from previous 40.3, above consensus of 41.1
#10:00 USD: ISM Non-Manufacturing Business Activity (Aug) at 57.3, up from previous 57.1
#10:00 USD: ISM Non-Manufacturing Employment (Aug) at 54.7, up from previous 50.7
#10:00 USD: ISM Non-Manufacturing New Orders (Aug) at 57.5, up from previous 55.0
#10:00 USD: ISM Non-Manufacturing PMI (Aug) at 54.5, up from previous 52.7, above consensus of 52.5
#10:00 USD: ISM Non-Manufacturing Prices (Aug) at 58.9, up from previous 56.8
#10:00 CAD: BoC Interest Rate Decision at 5.00%, same from previous 5.00%, in line with consensus of 5.00%
#16:30 USD: API Weekly Crude Oil Stock at -5.521M, up from previous -11.486M, below consensus of -1.429M
#19:50 JPY: Foreign Bonds Buying at 90.7B, down from previous 425.3B
#19:50 JPY: Foreign Investments in Japanese Stocks at 531.9B, up from previous -603.2B
#19:50 JPY: Foreign Reserves (USD) (Aug) at 1,251.2B, down from previous 1,253.7B
#
#### Upcoming Economic Releases
#23:00 CNY: Exports (Aug) upcoming release, previous figure at -9.20M
#23:00 CNY: Imports (Aug) upcoming release, previous figure at -6.90M
#23:00 CNY: Trade Balance (Aug) upcoming release, previous figure at 575.70M
#23:00 CNY: Exports (YoY) (Aug) upcoming release, previous figure at -14.5%
#23:00 CNY: Imports (YoY) (Aug) upcoming release, previous figure at -12.4%
#23:00 CNY: Trade Balance (USD) (Aug) upcoming release, previous figure at 80.60B
#23:35 JPY: 30-Year JGB Auction upcoming release, previous figure at 1.593% 
# 
#### M&A Activity: 
# 
# 
#### Headlines: 
#
#


### Script
import pandas as pd
import numpy as np
from bs4 import BeautifulSoup
import requests
from urllib.request import Request, urlopen
from urllib.error import URLError, HTTPError
import datetime as dt
import math
import re
import warnings
import os
warnings.simplefilter("ignore")

indicators = {
            "SPX": "https://ca.finance.yahoo.com/quote/%5EGSPC?p=%5EGSPC",
            "DJI": "https://ca.finance.yahoo.com/quote/%5EDJI?p=%5EDJI",
            "NASDAQ": "https://ca.finance.yahoo.com/quote/%5EIXIC?p=^IXIC&.tsrc=fin-srch",
            "Russell 2000": "https://ca.finance.yahoo.com/quote/%5ERUT?p=%5ERUT",
            "S&P/TSX": "https://ca.finance.yahoo.com/quote/%5EGSPTSE?p=%5EGSPTSE",
            "FTSE 100": "https://ca.finance.yahoo.com/quote/%5EFTSE?p=%5EFTSE",
            "Euro Stoxx 50 Eur": "https://ca.investing.com/indices/eu-stoxx50", 
            "Shanghai Composite Index": "https://finance.yahoo.com/quote/000001.SS",
            "Hang Seng Index": "https://ca.finance.yahoo.com/quote/%5EHSI?p=^HSI&.tsrc=fin-srch",
            "Nikkei 225": "https://ca.finance.yahoo.com/quote/%5EN225?p=%5EN225",
            "VIX": "https://ca.finance.yahoo.com/quote/%5EVIX?p=^VIX&.tsrc=fin-srch",
            "STOXX 50 Volatility Eur": "https://www.investing.com/indices/stoxx-50-volatility-vstoxx-eur",
            "US Dollar Index": "https://ca.finance.yahoo.com/quote/%5ENYICDX?p=^NYICDX&.tsrc=fin-srch",
            "USD/CAD": "https://ca.finance.yahoo.com/quote/CAD=X?p=CAD=X&.tsrc=fin-srch",
            "EUR/USD": "https://ca.finance.yahoo.com/quote/EURUSD=X?p=EURUSD=X&.tsrc=fin-srch",
            "USD/CNY": "https://ca.finance.yahoo.com/quote/CNY=X?p=CNY=X&.tsrc=fin-srch",
            "USD/JPY": "https://ca.finance.yahoo.com/quote/JPY=X?p=JPY=X&.tsrc=fin-srch",
            "GBP/USD": "https://ca.finance.yahoo.com/quote/GBPUSD=X?p=GBPUSD=X&.tsrc=fin-srch",
            "SOFR": "https://www.sofrrate.com/",                                            
            "Headline CPI":"https://fred.stlouisfed.org/series/CPIAUCSL",
            "Core CPI":"https://fred.stlouisfed.org/series/CPILFESL",
            "Fed Funds":"https://fred.stlouisfed.org/series/FEDFUNDS",
            "Unemp. Rate":"https://fred.stlouisfed.org/series/UNRATE",
            "US 1 Month Yield":"https://www.marketwatch.com/investing/bond/tmubmusd01m?countryCode=BX",
            "US 3 Month Yield":"https://www.marketwatch.com/investing/bond/tmubmusd03m?countryCode=BX",
            "US 6 Month Yield":"https://www.marketwatch.com/investing/bond/tmubmusd06m?countryCode=BX",
            "US 1 Year Yield":"https://www.marketwatch.com/investing/bond/tmubmusd01y?countryCode=BX",
            "US 2 Year Yield":"https://www.marketwatch.com/investing/bond/tmubmusd02y?countryCode=BX",
            "US 3 Year Yield":"https://www.marketwatch.com/investing/bond/tmubmusd03y?countryCode=BX",
            "US 5 Year Yield":"https://www.marketwatch.com/investing/bond/tmubmusd05y?countryCode=BX",
            "US 7 Year Yield":"https://www.marketwatch.com/investing/bond/tmubmusd07y?countryCode=BX",
            "US 10 Year Yield":"https://www.marketwatch.com/investing/bond/tmubmusd10y?countryCode=BX",
            "US 30 Year Yield":"https://www.marketwatch.com/investing/bond/tmubmusd30y?countryCode=BX"
        }

class finreport:
    def __init__(self):
        self.econ_calendar_link = "https://www.investing.com/economic-calendar/"
        self.yahoo_indicators = {key: value for key, value in indicators.items() if "ca.finance.yahoo.com" in value}
        self.bond_indicators = {key: value for key, value in indicators.items() if "www.marketwatch.com/investing/bond" in value}
        self.econ_indicators = {key: value for key, value in indicators.items() if "fred.stlouisfed.org" in value}
        self.investing_indicators = {key: value for key, value in indicators.items() if "investing.com" in value}
        self.sofr_indicators = {key: value for key, value in indicators.items() if "sofrrate.com" in value}
    def get_indicators(self):
        temp_dict1 = {}
        for key, value in self.yahoo_indicators.items():
            with urlopen(Request(url = value, headers={'User-Agent': 'Mozilla/5.0'})) as response:
                webpage = response.read()
            soup = BeautifulSoup(webpage, 'html.parser')
            open_value = float((soup.find('td', attrs={'class': 'Ta(end) Fw(600) Lh(14px)', 'data-test': 'OPEN-value'}).text).replace(",",""))
            temp_dict1[key] = open_value

        for key, value in self.bond_indicators.items():
            with urlopen(Request(url = value, headers={'User-Agent': 'Mozilla/5.0'})) as response:
                webpage = response.read()
            soup = BeautifulSoup(webpage, 'html.parser')
            return_value = "{:.3f}".format(float((soup.find('h2', class_='intraday__price sup--right').get_text()).replace("$","").replace("%","")))
            temp_dict1[key] = return_value

        for key, value in self.econ_indicators.items():
            with urlopen(Request(url = value, headers={'User-Agent': 'Mozilla/5.0'})) as response:
                webpage = response.read()
            soup = BeautifulSoup(webpage, 'html.parser')
            as_of_date = soup.find('span', {'class': 'series-meta-value'}).text.replace(":","")
            return_value = soup.find('span', {'class': 'series-meta-observation-value'}).text
            temp_dict1[key] = return_value

        for key, value in self.investing_indicators.items():
            with urlopen(Request(url = value, headers={'User-Agent': 'Mozilla/5.0'})) as response:
                webpage = response.read()
            soup = BeautifulSoup(webpage, 'html.parser')
            return_value = "{:.2f}".format(float(soup.find('span', class_='key-info_dd-numeric__ZQFIs').get_text().replace(",","")))
            temp_dict1[key] = return_value

        for key, value in self.sofr_indicators.items():
            with urlopen(Request(url = value, headers={'User-Agent': 'Mozilla/5.0'})) as response:
                webpage = response.read()
            soup = BeautifulSoup(webpage, 'html.parser')
            cleaned_sofr = float(re.findall(r'[-\d.,]+', soup.find('p', class_='sofrrate').get_text())[0])
            temp_dict1[key] = cleaned_sofr

        commodities_df = pd.read_html("https://markets.businessinsider.com/commodities/realtime-list")[0]
        commodities_df = commodities_df.drop(columns=commodities_df.columns[-1])
        commodities_df.columns = ["Commodity", "Last", "Previous Close", "%", "Absolute", "Trade Time", "Unit"]
        commodities_df = commodities_df.dropna(subset=["Commodity"])
        commodities_df = commodities_df.reset_index(drop=True)
        commodities_df["Commodity"] = commodities_df["Commodity"].str.replace(" \(Henry Hub\)", "")
        
        os.chdir("/home/cole/Sync/jupyter_projects/datafiles")
        os.listdir()
        log_figures = pd.read_csv("finance_data_log.csv", delimiter="\t")
        
        commodity_copy = commodities_df[["Commodity", "Last"]]
        commodity_copy.columns = ["Indicator", "Last"]
        updated_figures = pd.concat([pd.DataFrame(list(temp_dict1.items()), columns=["Indicator", f"Last"]), commodity_copy]).reset_index(drop=True)

        current_date_string = dt.datetime.today().strftime('%Y-%m-%d')

        if (pd.to_datetime(log_figures.columns[1]).month == 12) & (dt.datetime.today().month == 1):
            log_figures[log_figures.columns[1]] = updated_figures["Last"]
            new_columns = log_figures.columns.tolist()
            new_columns[1] = current_date_string
            log_figures.columns = new_columns
            os.chdir("/home/cole/Sync/jupyter_projects/datafiles")
            log_figures.to_csv("finance_data_log.csv", sep="\t", index=False, mode='w')
            
        combined_df = updated_figures.merge(log_figures, on="Indicator")

        commentary_str = ""

        col1 = combined_df.columns[0]
        col2 = combined_df.columns[1]
        col3 = combined_df.columns[2]

        for index, row in combined_df.iterrows():
            indicator = row[col1]
            current = row[col2]
            ytd = row[col3]

            if not (pd.isna(ytd)) or (pd.isna(current)):
                ytd_chg = (float(current)/float(ytd))-1
                if ytd_chg >= 0:
                    ytd_comment = f", up {round(float(ytd_chg),2)}% YTD"
                else:
                    ytd_comment = f", down {round(float(ytd_chg),2)}% YTD"
            else:
                ytd_comment = ""

            commentary_str = commentary_str + f"{indicator}: {current}{ytd_comment}\n"

        return commentary_str
    def write_indicator_commentary(self, row):
        time = str(row["Time"])
        cur = str(row["Cur"])
        event = str(row["Event"])
        actual = str(row["Actual"])
        if len(re.findall(r'[-\d.,]+', actual)) == 0:
            actual_num = np.nan
        else:
            actual_num = float(re.findall(r'[-\d.,]+', actual)[0].replace(",",""))

        forecast = str(row["Forecast"])
        if len(re.findall(r'[-\d.,]+', forecast)) == 0:
            forecast_num = np.nan
        else:
            forecast_num = float(re.findall(r'[-\d.,]+', forecast)[0].replace(",",""))

        previous = str(row["Previous"])
        if len(re.findall(r'[-\d.,]+', previous)) == 0:
            previous_num = np.nan
        else:
            previous_num = float(re.findall(r'[-\d.,]+', previous)[0].replace(",",""))

        if pd.isna(actual_num):
            return f"{time} {cur}: {event} upcoming release, previous figure at {previous}"
        elif pd.isna(previous_num):
            return f"{time} {cur}: {event} upcoming release"
        elif actual_num > previous_num:
            up_or_down = "up"
        elif actual_num < previous_num:
            up_or_down = "down"
        else:
            up_or_down = "same"

        if pd.isna(forecast_num):
            return f"{time} {cur}: {event} at {actual}, {up_or_down} from previous {previous}"

        elif actual_num > forecast_num:
            above_or_below = "above"
        elif actual_num < forecast_num:
            above_or_below = "below"
        else:
            above_or_below = "in line with"
        return f"{time} {cur}: {event} at {actual}, {up_or_down} from previous {previous}, {above_or_below} consensus of {forecast}"

    def get_econ_calendar(self):
        with urlopen(Request(url = self.econ_calendar_link, headers={'User-Agent': 'Mozilla/5.0'})) as response:
            webpage = response.read()
        economic_events = pd.read_html(webpage)[2]
        economic_events.columns = ["Time", "Cur", "Importance", "Event", "Actual", "Forecast", "Previous", "Extra1", "Extra2"]
        economic_events = economic_events.drop(columns=["Extra1", "Extra2"], index=0)
        economic_events = economic_events[economic_events["Cur"].isin(["JPY", "EUR", "CNY", "USD", "CAD"])]

        if len(list(economic_events[economic_events["Importance"] == "Holiday"]["Event"].drop_duplicates())) == 0:
            holidays = "No market holidays today"
        else:
            holidays = "\n".join(list(economic_events[economic_events["Importance"] == "Holiday"]["Event"].drop_duplicates()))

        speeches = economic_events[economic_events[["Actual", "Forecast", "Previous"]].isnull().all(axis=1)][["Time", "Event"]]
        speeches["Final"] = economic_events["Event"].astype(str) + " at " + economic_events["Time"]
        speeches_string = "\n".join(list(speeches["Final"]))

        indicators = economic_events[~((economic_events["Event"].isin(speeches["Event"])) | (economic_events["Event"].isin(economic_events[economic_events["Importance"] == "Holiday"]["Event"].drop_duplicates())))].reset_index(drop=True)
        indicators = indicators.fillna("NA")

        already_released = indicators[indicators["Actual"] != "NA"]
        coming_up = indicators[indicators["Actual"] == "NA"]

        already_released["Commentary"] = already_released.apply(lambda x: finreport().write_indicator_commentary(x), axis=1)
        released_data_string = "\n".join(list(already_released["Commentary"]))

        coming_up["Commentary"] = coming_up.apply(lambda x:  finreport().write_indicator_commentary(x), axis=1)
        upcoming_data_string = "\n".join(list(coming_up["Commentary"]))

        return f"### Holidays\n{holidays}\n\n### Speeches\n{speeches_string}\n\n### Economic Releases Today\n {released_data_string}\n\n### Upcoming Economic Releases\n{upcoming_data_string}"
    def write_commentary(self):
        indicator_string = finreport().get_indicators()
        econ_string = finreport().get_econ_calendar()
        ma_activity = input("M&A Activity? ")
        cleaned_ma_activity = "\n".join([f"- {n}" for n in [ele.strip() for ele in ma_activity.split("+") if ele.strip() != ""]])
        headlines = input("Headlines? ")
        cleaned_headlines = "\n".join([f"- {n}" for n in [ele.strip() for ele in headlines.split("+") if ele.strip() != ""]])

        today = dt.datetime.today()
        return (f"\n# {today.month}/{today.day}/{today.year}\n\n{indicator_string}\n{econ_string}\n### M&A Activity: \n {cleaned_ma_activity}\n ### Headlines: \n {cleaned_headlines}")

text_current = finreport().write_commentary()

with open("/home/cole/Sync/jupyter_projects/daily_finance_report.txt", "w") as export_file:
    export_file.write(text_current)
